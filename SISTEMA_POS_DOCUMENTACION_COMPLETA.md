# üè™ SISTEMA POS - DOCUMENTACI√ìN COMPLETA PARA ESTANDARIZACI√ìN

## üìã √çNDICE

1. [Variables de Entorno](#variables-de-entorno)
2. [Modelo de Autenticaci√≥n](#modelo-de-autenticaci√≥n)
3. [Estructura de Base de Datos](#estructura-de-base-de-datos)
4. [Relaciones entre Tablas](#relaciones-entre-tablas)
5. [Validaciones de Caja](#validaciones-de-caja)
6. [Validaciones de Stock](#validaciones-de-stock)
7. [Validaciones de Ventas](#validaciones-de-ventas)
8. [Configuraci√≥n de Supabase Storage](#configuraci√≥n-de-supabase-storage)
9. [Arquitectura del Sistema](#arquitectura-del-sistema)
10. [Flujos de Negocio](#flujos-de-negocio)

---

## üîß VARIABLES DE ENTORNO

### **Variables Requeridas**

```bash
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_URL=your_supabase_project_url
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
CLERK_SECRET_KEY=your_clerk_secret_key
```

### **Configuraci√≥n de Variables**

1. **Crear archivo `.env.local`** en la ra√≠z del proyecto
2. **Obtener claves de Supabase:**
   - Ir a Dashboard de Supabase ‚Üí Settings ‚Üí API
   - Copiar `Project URL` y `anon public` key
   - Copiar `service_role` key (para Server Actions)

3. **Obtener claves de Clerk:**
   - Ir a Dashboard de Clerk ‚Üí API Keys
   - Copiar `Publishable Key` y `Secret Key`

---

## üîê MODELO DE AUTENTICACI√ìN

### **Arquitectura de Autenticaci√≥n**

El sistema utiliza **Clerk** para autenticaci√≥n y **Supabase** para almacenamiento de datos de usuario.

#### **Flujo de Autenticaci√≥n:**

1. **Registro/Login:** Usuario se registra/inicia sesi√≥n en Clerk
2. **Sincronizaci√≥n:** El `clerk_user_id` se sincroniza con la tabla `usuarios` en Supabase
3. **Autorizaci√≥n:** Server Actions verifican permisos basados en el rol del usuario

#### **Roles de Usuario:**

```typescript
type UserRole = 'admin' | 'supervisor' | 'cobrador';
```

- **Admin:** Acceso completo a todas las funcionalidades
- **Supervisor:** Acceso a lectura y escritura (sin eliminaci√≥n)
- **Cobrador:** Acceso limitado a ventas y caja

#### **Tabla de Usuarios:**

```sql
CREATE TABLE public.usuarios (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre text NOT NULL,
  email text UNIQUE NOT NULL,
  telefono text,
  password_hash text,
  rol text NOT NULL DEFAULT 'cobrador' CHECK (rol IN ('admin', 'supervisor', 'cobrador')),
  creado_el timestamp with time zone DEFAULT now(),
  prueba_gratis boolean DEFAULT true,
  clerk_user_id text UNIQUE
);
```

---

## üóÑÔ∏è ESTRUCTURA DE BASE DE DATOS

### **Tablas Principales**

#### **1. Configuraci√≥n de Empresa**
```sql
CREATE TABLE public.configuracion (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  creado_el timestamp with time zone DEFAULT now(),
  nombre text,
  imagen text,
  color_primario text DEFAULT '#22c55e'
);
```

#### **2. Usuarios**
```sql
CREATE TABLE public.usuarios (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre text NOT NULL,
  email text UNIQUE NOT NULL,
  telefono text,
  password_hash text,
  rol text NOT NULL DEFAULT 'cobrador',
  creado_el timestamp with time zone DEFAULT now(),
  prueba_gratis boolean DEFAULT true,
  clerk_user_id text UNIQUE
);
```

#### **3. Entidades (Clientes/Proveedores)**
```sql
CREATE TABLE public.entidades (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  razon_social text NOT NULL,
  tipo text NOT NULL CHECK (tipo IN ('cliente', 'proveedor')),
  email text,
  tipo_doc text CHECK (tipo_doc IN ('dni', 'cuit', 'cuil')),
  num_doc text,
  telefono text,
  categoria_iva text CHECK (categoria_iva IN ('Consumidor Final', 'Responsable Inscripto', 'Responsable Monotributo', 'Exento', 'No Responsable', 'Sujeto no Categorizado')),
  maximo_cuenta_corriente numeric(10,2)
);
```

#### **4. Art√≠culos**
```sql
CREATE TABLE public.articulos (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  descripcion text NOT NULL,
  precio_unitario numeric(10,2) NOT NULL,
  fk_id_agrupador bigint REFERENCES agrupadores(id),
  fk_id_marca bigint REFERENCES marcas(id),
  activo boolean DEFAULT true,
  stock numeric(10,2) DEFAULT 0
);
```

#### **5. Variantes de Art√≠culos**
```sql
CREATE TABLE public.variantes_articulos (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  creado_el timestamp with time zone DEFAULT now(),
  fk_id_articulo bigint REFERENCES articulos(id),
  stock_unitario integer DEFAULT 0,
  fk_id_talle bigint REFERENCES talles(id),
  fk_id_color bigint REFERENCES color(id)
);
```

#### **6. Cajas**
```sql
CREATE TABLE public.cajas (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  descripcion text NOT NULL,
  turno text
);
```

#### **7. Lotes de Operaciones**
```sql
CREATE TABLE public.lotes_operaciones (
  id_lote bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  fk_id_usuario bigint REFERENCES usuarios(id),
  fk_id_caja bigint REFERENCES cajas(id),
  abierto boolean DEFAULT true,
  tipo_lote text CHECK (tipo_lote IN ('apertura', 'cierre')),
  fecha_apertura timestamp with time zone DEFAULT now(),
  hora_apertura text,
  fecha_cierre timestamp with time zone,
  hora_cierre text,
  observaciones text,
  saldo_inicial numeric(10,2) DEFAULT 0
);
```

#### **8. √ìrdenes de Venta**
```sql
CREATE TABLE public.ordenes_venta (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  fk_id_entidades bigint REFERENCES entidades(id),
  fk_id_usuario bigint REFERENCES usuarios(id),
  fk_id_lote bigint REFERENCES lotes_operaciones(id_lote),
  fk_id_tipo_comprobante bigint REFERENCES tipos_comprobantes(id),
  fecha timestamp with time zone DEFAULT now(),
  total numeric(10,2) NOT NULL,
  subtotal numeric(10,2) NOT NULL
);
```

#### **9. Detalles de √ìrdenes de Venta**
```sql
CREATE TABLE public.ordenes_venta_detalle (
  idd bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  fk_id_orden bigint REFERENCES ordenes_venta(id),
  fk_id_articulo bigint REFERENCES articulos(id),
  cantidad integer NOT NULL,
  precio_unitario numeric(10,2) NOT NULL,
  fk_id_talle bigint REFERENCES talles(id),
  fk_id_color bigint REFERENCES color(id)
);
```

#### **10. Medios de Pago**
```sql
CREATE TABLE public.ordenes_venta_medios_pago (
  idd bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  fk_id_orden bigint REFERENCES ordenes_venta(id),
  fk_id_cuenta_tesoreria bigint REFERENCES cuentas_tesoreria(id),
  monto_pagado numeric(10,2) NOT NULL
);
```

#### **11. Cuentas de Tesorer√≠a**
```sql
CREATE TABLE public.cuentas_tesoreria (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  descripcion text NOT NULL,
  activo boolean DEFAULT true
);
```

#### **12. Movimientos de Stock**
```sql
CREATE TABLE public.movimientos_stock (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  fk_id_articulos bigint REFERENCES articulos(id),
  fk_id_orden bigint REFERENCES ordenes_venta(id),
  origen text NOT NULL,
  tipo text NOT NULL,
  cantidad numeric(10,2),
  stock_actual numeric(10,2),
  creado_el timestamp with time zone DEFAULT now(),
  fk_id_talle bigint REFERENCES talles(id),
  fk_id_color bigint REFERENCES color(id)
);
```

#### **13. Cuentas Corrientes**
```sql
CREATE TABLE public.cuentas_corrientes (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  creada_el timestamp with time zone DEFAULT now(),
  fk_id_orden bigint REFERENCES ordenes_venta(id),
  fk_id_cliente bigint REFERENCES entidades(id),
  total numeric(10,2) NOT NULL,
  saldo numeric(10,2) NOT NULL,
  estado text CHECK (estado IN ('pendiente', 'pagada', 'cancelado'))
);
```

#### **14. Pagos de Cuenta Corriente**
```sql
CREATE TABLE public.pagos_cuenta_corriente (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  fk_id_cuenta_corriente bigint REFERENCES cuentas_corrientes(id),
  monto numeric(10,2) NOT NULL,
  fecha_pago timestamp with time zone DEFAULT now(),
  fk_id_usuario bigint REFERENCES usuarios(id),
  fk_id_lote bigint REFERENCES lotes_operaciones(id_lote)
);
```

#### **15. Detalles de Lotes de Operaciones**
```sql
CREATE TABLE public.detalle_lotes_operaciones (
  idd bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  fk_id_lote bigint REFERENCES lotes_operaciones(id_lote),
  fk_id_cuenta_tesoreria bigint REFERENCES cuentas_tesoreria(id),
  tipo text CHECK (tipo IN ('ingreso', 'egreso')),
  monto numeric(10,2) NOT NULL,
  fecha_movimiento timestamp with time zone DEFAULT now()
);
```

#### **16. Tablas de Cat√°logo**

**Agrupadores:**
```sql
CREATE TABLE public.agrupadores (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre text NOT NULL,
  activo boolean DEFAULT true
);
```

**Marcas:**
```sql
CREATE TABLE public.marcas (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  descripcion text NOT NULL,
  activo boolean DEFAULT true
);
```

**Colores:**
```sql
CREATE TABLE public.color (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  descripcion text NOT NULL,
  activo boolean DEFAULT true
);
```

**Talles:**
```sql
CREATE TABLE public.talles (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  descripcion text NOT NULL,
  activo boolean DEFAULT true
);
```

**Tipos de Comprobantes:**
```sql
CREATE TABLE public.tipos_comprobantes (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  descripcion text NOT NULL,
  activo boolean DEFAULT true,
  reingresa_stock boolean DEFAULT false
);
```

**Tipos de Gasto:**
```sql
CREATE TABLE public.tipo_gasto (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  descripcion text,
  obliga_empleado boolean,
  afecta_caja boolean
);
```

**Empleados:**
```sql
CREATE TABLE public.empleados (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre text NOT NULL,
  apellido text,
  telefono text,
  email text,
  activo boolean DEFAULT true
);
```

**Gastos de Empleados:**
```sql
CREATE TABLE public.gastos_empleados (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  creado_el timestamp with time zone DEFAULT now(),
  fk_tipo_gasto bigint REFERENCES tipo_gasto(id),
  monto numeric(10,2) NOT NULL,
  descripcion text,
  fk_empleado bigint REFERENCES empleados(id),
  fk_lote_operaciones bigint REFERENCES lotes_operaciones(id_lote),
  fk_usuario bigint REFERENCES usuarios(id),
  fk_cuenta_tesoreria bigint REFERENCES cuentas_tesoreria(id)
);
```

**Liquidaciones:**
```sql
CREATE TABLE public.liquidaciones (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  fk_id_empleado bigint REFERENCES empleados(id),
  fecha_inicio date NOT NULL,
  fecha_fin date NOT NULL,
  total_ventas numeric(10,2) DEFAULT 0,
  comision numeric(10,2) DEFAULT 0,
  total_liquidacion numeric(10,2) DEFAULT 0,
  estado text DEFAULT 'pendiente'
);
```

---

## üîó RELACIONES ENTRE TABLAS

### **Diagrama de Relaciones Principales**

```
usuarios (1) ‚Üê‚Üí (N) lotes_operaciones
cajas (1) ‚Üê‚Üí (N) lotes_operaciones
lotes_operaciones (1) ‚Üê‚Üí (N) detalle_lotes_operaciones
lotes_operaciones (1) ‚Üê‚Üí (N) gastos_empleados

entidades (1) ‚Üê‚Üí (N) ordenes_venta
usuarios (1) ‚Üê‚Üí (N) ordenes_venta
lotes_operaciones (1) ‚Üê‚Üí (N) ordenes_venta
tipos_comprobantes (1) ‚Üê‚Üí (N) ordenes_venta

ordenes_venta (1) ‚Üê‚Üí (N) ordenes_venta_detalle
ordenes_venta (1) ‚Üê‚Üí (N) ordenes_venta_medios_pago
ordenes_venta (1) ‚Üê‚Üí (1) cuentas_corrientes

articulos (1) ‚Üê‚Üí (N) ordenes_venta_detalle
articulos (1) ‚Üê‚Üí (N) variantes_articulos
articulos (1) ‚Üê‚Üí (N) movimientos_stock

agrupadores (1) ‚Üê‚Üí (N) articulos
marcas (1) ‚Üê‚Üí (N) articulos
talles (1) ‚Üê‚Üí (N) variantes_articulos
color (1) ‚Üê‚Üí (N) variantes_articulos

cuentas_tesoreria (1) ‚Üê‚Üí (N) ordenes_venta_medios_pago
cuentas_tesoreria (1) ‚Üê‚Üí (N) detalle_lotes_operaciones
cuentas_tesoreria (1) ‚Üê‚Üí (N) gastos_empleados

empleados (1) ‚Üê‚Üí (N) gastos_empleados
empleados (1) ‚Üê‚Üí (N) liquidaciones
tipo_gasto (1) ‚Üê‚Üí (N) gastos_empleados
```

### **Relaciones Clave**

1. **Lotes de Operaciones:** Central para control de caja
2. **√ìrdenes de Venta:** N√∫cleo del sistema de ventas
3. **Variantes:** Gesti√≥n de stock por talle/color
4. **Movimientos de Stock:** Trazabilidad completa

---

## üí∞ VALIDACIONES DE CAJA

### **Apertura de Caja**

```typescript
// Validaciones implementadas
const validacionesAperturaCaja = {
  // 1. Validar prueba gratis
  pruebaGratis: async (usuarioId: number) => {
    const usuario = await getUsuarioById(usuarioId);
    if (usuario?.prueba_gratis) {
      const diasTranscurridos = calcularDiasDesdeCreacion(usuario.creado_el);
      if (diasTranscurridos > 15) {
        throw new Error('Per√≠odo de prueba gratuito expirado');
      }
    }
  },

  // 2. Validar caja no abierta
  cajaNoAbierta: async () => {
    const loteAbierto = await getLoteAbierto();
    if (loteAbierto) {
      throw new Error('Ya hay una caja abierta');
    }
  },

  // 3. Validar datos requeridos
  datosRequeridos: (cajaId: number, saldoInicial: number, usuarioId: number) => {
    if (!cajaId || !saldoInicial || !usuarioId) {
      throw new Error('Todos los campos son obligatorios');
    }
  }
};
```

### **Cierre de Caja**

```typescript
// Validaciones implementadas
const validacionesCierreCaja = {
  // 1. Validar lote abierto
  loteAbierto: async (loteId: number) => {
    const lote = await getLoteById(loteId);
    if (!lote || !lote.abierto) {
      throw new Error('No hay un lote abierto para cerrar');
    }
  },

  // 2. Calcular movimientos
  calcularMovimientos: async (loteId: number) => {
    const movimientos = await getDetalleLotesOperaciones(loteId);
    const resumen = calcularResumenPorCuenta(movimientos);
    return resumen;
  },

  // 3. Generar reporte
  generarReporte: (resumen: any[]) => {
    return {
      fechaCierre: new Date(),
      resumenPorCuenta: resumen,
      totalIngresos: resumen.reduce((acc, c) => acc + c.ingresos, 0),
      totalEgresos: resumen.reduce((acc, c) => acc + c.egresos, 0)
    };
  }
};
```

### **Movimientos de Caja**

```typescript
// Tipos de movimientos
type TipoMovimiento = 'ingreso' | 'egreso';

// Validaciones de movimientos
const validacionesMovimientos = {
  // 1. Validar lote abierto
  loteAbierto: async (loteId: number) => {
    const lote = await getLoteById(loteId);
    if (!lote?.abierto) {
      throw new Error('No hay un lote abierto');
    }
  },

  // 2. Validar monto positivo
  montoPositivo: (monto: number) => {
    if (monto <= 0) {
      throw new Error('El monto debe ser mayor a 0');
    }
  },

  // 3. Validar cuenta de tesorer√≠a
  cuentaValida: async (cuentaId: number) => {
    const cuenta = await getCuentaTesoreriaById(cuentaId);
    if (!cuenta?.activo) {
      throw new Error('Cuenta de tesorer√≠a inv√°lida');
    }
  }
};
```

---

## üì¶ VALIDACIONES DE STOCK

### **Gesti√≥n de Stock por Variantes**

```typescript
// Validaciones de stock implementadas
const validacionesStock = {
  // 1. Validar stock disponible
  stockDisponible: async (articuloId: number, talleId: number, colorId: number, cantidad: number) => {
    const variante = await getVarianteByArticuloTalleColor(articuloId, talleId, colorId);
    if (!variante || variante.stock_unitario < cantidad) {
      throw new Error('Stock insuficiente');
    }
  },

  // 2. Actualizar stock al vender
  actualizarStockVenta: async (varianteId: number, cantidad: number) => {
    const variante = await getVarianteById(varianteId);
    const nuevoStock = variante.stock_unitario - cantidad;
    if (nuevoStock < 0) {
      throw new Error('Stock insuficiente');
    }
    await updateVariante(varianteId, { stock_unitario: nuevoStock });
  },

  // 3. Registrar movimiento de stock
  registrarMovimiento: async (data: {
    fk_id_articulos: number;
    fk_id_orden?: number;
    origen: string;
    tipo: 'entrada' | 'salida';
    cantidad: number;
    fk_id_talle?: number;
    fk_id_color?: number;
  }) => {
    await createMovimientoStock(data);
  }
};
```

### **Tipos de Origen de Movimientos**

```typescript
type OrigenMovimiento = 
  | 'FACTURA'      // Venta
  | 'AJUSTE'       // Ajuste manual
  | 'COMPRA'       // Compra a proveedor
  | 'DEVOLUCION'   // Devoluci√≥n de cliente
  | 'TRANSFERENCIA'; // Transferencia entre dep√≥sitos
```

### **C√°lculo de Stock Total**

```typescript
// C√°lculo autom√°tico de stock total por art√≠culo
const calcularStockTotal = async (articuloId: number) => {
  const variantes = await getVariantesByArticulo(articuloId);
  const stockTotal = variantes.reduce((acc, v) => acc + (v.stock_unitario || 0), 0);
  await updateArticle(articuloId, { stock: stockTotal });
  return stockTotal;
};
```

---

## üõí VALIDACIONES DE VENTAS

### **Validaciones Pre-Venta**

```typescript
// Validaciones implementadas en venta-form-dialog.tsx
const validacionesVenta = {
  // 1. Validar prueba gratis
  pruebaGratis: async (usuarioId: number) => {
    const usuario = await getUsuarioById(usuarioId);
    if (usuario?.prueba_gratis) {
      const diasTranscurridos = calcularDiasDesdeCreacion(usuario.creado_el);
      if (diasTranscurridos > 15) {
        throw new Error('Per√≠odo de prueba gratuito expirado');
      }
    }
  },

  // 2. Validar lote abierto
  loteAbierto: async (usuarioId: number) => {
    const lote = await getLoteCajaAbiertaPorUsuario(usuarioId);
    if (!lote || !lote.abierto) {
      throw new Error('Debe haber una caja abierta para registrar la venta');
    }
    return lote;
  },

  // 3. Validar medios de pago
  mediosPago: (mediosPago: any[]) => {
    if (!mediosPago || mediosPago.length === 0) {
      throw new Error('Debe seleccionar al menos un medio de pago');
    }
    
    const totalMediosPago = mediosPago.reduce((acc, m) => acc + m.monto, 0);
    if (totalMediosPago <= 0) {
      throw new Error('El monto total de medios de pago debe ser mayor a 0');
    }
  },

  // 4. Validar cuenta corriente
  cuentaCorriente: async (clienteId: number, total: number) => {
    const cliente = await getClienteById(clienteId);
    if (clienteId === 1) { // Consumidor Final
      throw new Error('No se puede usar cuenta corriente con Consumidor Final');
    }
    
    if (cliente?.maximo_cuenta_corriente && total > cliente.maximo_cuenta_corriente) {
      throw new Error(`El total supera el m√°ximo permitido para cuenta corriente`);
    }
  },

  // 5. Validar stock disponible
  stockDisponible: async (detalle: any[]) => {
    for (const item of detalle) {
      if (item.talle && item.color) {
        const variante = await getVarianteByArticuloTalleColor(
          item.articulo.id, 
          item.talle, 
          item.color
        );
        if (!variante || variante.stock_unitario < item.cantidad) {
          throw new Error(`Stock insuficiente para ${item.articulo.descripcion}`);
        }
      }
    }
  }
};
```

### **Proceso de Venta**

```typescript
// Flujo completo de venta
const procesoVenta = async (datosVenta: any) => {
  // 1. Crear orden de venta
  const ordenVenta = await createOrdenVenta({
    fk_id_entidades: datosVenta.clienteId,
    fk_id_usuario: datosVenta.usuarioId,
    fk_id_lote: datosVenta.loteId,
    fk_id_tipo_comprobante: datosVenta.tipoComprobanteId,
    fecha: new Date(),
    total: datosVenta.total,
    subtotal: datosVenta.subtotal
  });

  // 2. Crear detalles de venta
  for (const detalle of datosVenta.detalle) {
    await createOrdenVentaDetalle({
      fk_id_orden: ordenVenta.id,
      fk_id_articulo: detalle.articuloId,
      cantidad: detalle.cantidad,
      precio_unitario: detalle.precio,
      fk_id_talle: detalle.talleId,
      fk_id_color: detalle.colorId
    });

    // 3. Actualizar stock
    if (detalle.talleId && detalle.colorId) {
      const variante = await getVarianteByArticuloTalleColor(
        detalle.articuloId, 
        detalle.talleId, 
        detalle.colorId
      );
      await updateVariante(variante.id, {
        stock_unitario: variante.stock_unitario - detalle.cantidad
      });
    }

    // 4. Registrar movimiento de stock
    await createMovimientoStock({
      fk_id_orden: ordenVenta.id,
      fk_id_articulos: detalle.articuloId,
      origen: 'FACTURA',
      tipo: 'salida',
      cantidad: -detalle.cantidad,
      fk_id_talle: detalle.talleId,
      fk_id_color: detalle.colorId
    });
  }

  // 5. Crear medios de pago
  for (const medioPago of datosVenta.mediosPago) {
    await createOrdenVentaMediosPago({
      fk_id_orden: ordenVenta.id,
      fk_id_cuenta_tesoreria: medioPago.cuentaId,
      monto_pagado: medioPago.monto
    });

    // 6. Registrar movimiento de caja (excepto cuenta corriente)
    if (!medioPago.esCuentaCorriente) {
      await registrarMovimientoCaja({
        fk_id_lote: datosVenta.loteId,
        fk_id_cuenta_tesoreria: medioPago.cuentaId,
        tipo: 'ingreso',
        monto: medioPago.monto
      });
    }
  }

  // 7. Crear cuenta corriente si corresponde
  if (datosVenta.tieneCuentaCorriente) {
    await createCuentaCorriente({
      fk_id_orden: ordenVenta.id,
      fk_id_cliente: datosVenta.clienteId,
      total: datosVenta.total,
      saldo: datosVenta.total,
      estado: 'pendiente'
    });
  }
};
```

---

## üóÇÔ∏è CONFIGURACI√ìN DE SUPABASE STORAGE

### **Crear Bucket para Im√°genes**

#### **1. Desde Dashboard de Supabase:**

1. Ir a **Storage** en el dashboard
2. Click en **"New bucket"**
3. Configurar:
   - **Name:** `logos`
   - **Public bucket:** ‚úÖ Marcado
   - **File size limit:** 5MB
   - **Allowed MIME types:** `image/*`

#### **2. Configurar Pol√≠ticas RLS:**

```sql
-- Pol√≠tica para lectura p√∫blica de logos
CREATE POLICY "Logos p√∫blicos" ON storage.objects
FOR SELECT USING (bucket_id = 'logos');

-- Pol√≠tica para subida de logos (solo admin)
CREATE POLICY "Subida de logos" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'logos' 
  AND auth.role() = 'authenticated'
);
```

#### **3. Implementaci√≥n en C√≥digo:**

```typescript
// src/app/actions/configuracion.ts
export async function uploadLogoEmpresa(file: File) {
  const usuario = await checkUserPermissions();
  
  if (usuario.rol !== 'admin') {
    throw new Error('No tienes permisos para subir el logo de la empresa');
  }
  
  // Subir archivo
  const { data, error } = await supabase.storage
    .from('logos')
    .upload(`${Date.now()}-${file.name}`, file);
    
  if (error) throw error;
  
  // Obtener URL p√∫blica
  const { data: urlData } = supabase.storage
    .from('logos')
    .getPublicUrl(data.path);
    
  return urlData.publicUrl;
}
```

#### **4. Componente de Subida:**

```typescript
// src/components/configuracion/logo-upload.tsx
const handleFileUpload = async (file: File) => {
  try {
    const url = await uploadLogoEmpresa(file);
    await updateConfiguracionEmpresa({ imagen: url });
    showToast('Logo actualizado exitosamente');
  } catch (error) {
    showToast('Error al subir el logo', 'error');
  }
};
```

---

## üèóÔ∏è ARQUITECTURA DEL SISTEMA

### **Estructura de Carpetas**

```
src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ actions/           # Server Actions (Backend)
‚îÇ   ‚îú‚îÄ‚îÄ caja/             # P√°gina de gesti√≥n de caja
‚îÇ   ‚îú‚îÄ‚îÄ articles/         # P√°gina de art√≠culos
‚îÇ   ‚îú‚îÄ‚îÄ ventas/           # P√°gina de ventas
‚îÇ   ‚îî‚îÄ‚îÄ ...               # Otras p√°ginas
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/               # Componentes base (shadcn/ui)
‚îÇ   ‚îú‚îÄ‚îÄ articles/         # Componentes de art√≠culos
‚îÇ   ‚îú‚îÄ‚îÄ ventas/           # Componentes de ventas
‚îÇ   ‚îî‚îÄ‚îÄ ...               # Otros componentes
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îú‚îÄ‚îÄ use-*-secure.ts   # Hooks seguros con Server Actions
‚îÇ   ‚îî‚îÄ‚îÄ ...               # Otros hooks
‚îú‚îÄ‚îÄ types/                # Definiciones TypeScript
‚îú‚îÄ‚îÄ lib/                  # Utilidades y configuraci√≥n
‚îî‚îÄ‚îÄ services/             # ‚ö†Ô∏è DEPRECATED (usar Server Actions)
```

### **Patr√≥n de Arquitectura**

```
Frontend (Next.js) ‚Üí Server Actions ‚Üí Supabase Database
     ‚Üì                    ‚Üì              ‚Üì
  React Hooks    ‚Üí   Clerk Auth   ‚Üí   PostgreSQL
     ‚Üì                    ‚Üì              ‚Üì
  UI Components  ‚Üí   RBAC Logic   ‚Üí   Row Level Security
```

### **Flujo de Datos Seguro**

1. **Autenticaci√≥n:** Clerk maneja login/registro
2. **Autorizaci√≥n:** Server Actions verifican permisos
3. **Validaci√≥n:** Zod schemas validan datos
4. **Persistencia:** Supabase con RLS
5. **Respuesta:** Datos filtrados por permisos

---

## üîÑ FLUJOS DE NEGOCIO

### **Flujo de Venta Completo**

```mermaid
graph TD
    A[Cliente llega] --> B[Abrir caja]
    B --> C[Seleccionar art√≠culos]
    C --> D[Validar stock]
    D --> E[Calcular total]
    E --> F[Seleccionar medios de pago]
    F --> G[Validar cuenta corriente]
    G --> H[Crear orden de venta]
    H --> I[Actualizar stock]
    I --> J[Registrar movimientos de caja]
    J --> K[Generar comprobante]
    K --> L[Cerrar venta]
```

### **Flujo de Gesti√≥n de Caja**

```mermaid
graph TD
    A[Inicio de turno] --> B[Abrir caja]
    B --> C[Registrar saldo inicial]
    C --> D[Procesar ventas]
    D --> E[Registrar gastos]
    E --> F[Fin de turno]
    F --> G[Calcular movimientos]
    G --> H[Generar reporte]
    H --> I[Cerrar caja]
```

### **Flujo de Gesti√≥n de Stock**

```mermaid
graph TD
    A[Crear art√≠culo] --> B[Definir variantes]
    B --> C[Establecer stock inicial]
    C --> D[Venta]
    D --> E[Validar stock disponible]
    E --> F[Descontar stock]
    F --> G[Registrar movimiento]
    G --> H[Actualizar stock total]
```

---

## üìä REPORTES Y CONSULTAS

### **Reportes Disponibles**

1. **Cierre de Caja:** Resumen de movimientos por cuenta
2. **Ventas por Per√≠odo:** An√°lisis de ventas
3. **Stock por Art√≠culo:** Estado de inventario
4. **Cuentas Corrientes:** Saldos pendientes
5. **Liquidaciones:** Comisiones por empleado

### **Consultas Principales**

```sql
-- Stock total por art√≠culo
SELECT 
  a.descripcion,
  COALESCE(SUM(v.stock_unitario), 0) as stock_total
FROM articulos a
LEFT JOIN variantes_articulos v ON a.id = v.fk_id_articulo
WHERE a.activo = true
GROUP BY a.id, a.descripcion;

-- Ventas por per√≠odo
SELECT 
  DATE(ov.fecha) as fecha,
  COUNT(*) as cantidad_ventas,
  SUM(ov.total) as total_ventas
FROM ordenes_venta ov
WHERE ov.fecha BETWEEN $1 AND $2
GROUP BY DATE(ov.fecha)
ORDER BY fecha;

-- Movimientos de caja por lote
SELECT 
  ct.descripcion as cuenta,
  SUM(CASE WHEN dlo.tipo = 'ingreso' THEN dlo.monto ELSE 0 END) as ingresos,
  SUM(CASE WHEN dlo.tipo = 'egreso' THEN dlo.monto ELSE 0 END) as egresos
FROM detalle_lotes_operaciones dlo
JOIN cuentas_tesoreria ct ON dlo.fk_id_cuenta_tesoreria = ct.id
WHERE dlo.fk_id_lote = $1
GROUP BY ct.id, ct.descripcion;
```

---

## üé® SISTEMA DE COLORES PERSONALIZABLE

### **Descripci√≥n**

El sistema incluye un sistema de colores personalizable para el header del sidebar que permite a los usuarios personalizar la apariencia visual de la aplicaci√≥n.

### **Caracter√≠sticas**

- **8 colores predefinidos** disponibles para selecci√≥n
- **Persistencia en base de datos** del color seleccionado
- **Interfaz visual** con selector de colores en el modal de configuraci√≥n
- **Carga autom√°tica** del color guardado al iniciar la aplicaci√≥n

### **Paleta de Colores Disponible**

```typescript
const DATABASE_COLORS = [
  { name: "Verde", value: "#22c55e", class: "bg-green-500" },
  { name: "Azul", value: "#3b82f6", class: "bg-blue-500" },
  { name: "Rojo", value: "#ef4444", class: "bg-red-500" },
  { name: "P√∫rpura", value: "#8b5cf6", class: "bg-purple-500" },
  { name: "Naranja", value: "#f97316", class: "bg-orange-500" },
  { name: "Teal", value: "#14b8a6", class: "bg-teal-500" },
  { name: "Rosa", value: "#ec4899", class: "bg-pink-500" },
  { name: "Indigo", value: "#6366f1", class: "bg-indigo-500" },
];
```

### **Implementaci√≥n T√©cnica**

#### **1. Contexto de Colores**
```typescript
// src/contexts/ColorContext.tsx
export function ColorProvider({ children }: { children: React.ReactNode }) {
  const [selectedColor, setSelectedColor] = useState('#22c55e');
  // ... carga desde base de datos
}
```

#### **2. Aplicaci√≥n en Sidebar**
```typescript
// src/components/app-sidebar.tsx
<div 
  className="px-4 pt-4 pb-2"
  style={{ backgroundColor: selectedColor }}
>
```

#### **3. Selector Visual**
```typescript
// Selector de colores en modal de configuraci√≥n
<div className="grid grid-cols-4 gap-2 mt-2">
  {DATABASE_COLORS.map((color) => (
    <button
      key={color.value}
      onClick={() => setSelectedColor(color.value)}
      className={`w-10 h-10 rounded-full border-2 transition-all ${
        selectedColor === color.value 
          ? 'border-gray-800 scale-110' 
          : 'border-gray-300 hover:scale-105'
      }`}
      style={{ backgroundColor: color.value }}
      title={color.name}
    />
  ))}
</div>
```

### **Base de Datos**

El color seleccionado se almacena en la tabla `configuracion`:

```sql
-- Campo agregado a la tabla configuracion
color_primario text DEFAULT '#22c55e'
```

### **Flujo de Funcionamiento**

1. **Carga inicial:** El ColorProvider carga el color desde la base de datos
2. **Aplicaci√≥n:** El color se aplica al header del sidebar
3. **Selecci√≥n:** Usuario selecciona nuevo color en modal de configuraci√≥n
4. **Persistencia:** El color se guarda en la base de datos
5. **Actualizaci√≥n:** El header se actualiza inmediatamente

---

## üöÄ DEPLOYMENT Y CONFIGURACI√ìN

### **Requisitos del Sistema**

- **Node.js:** 18.x o superior
- **Next.js:** 15.x
- **Supabase:** Proyecto configurado
- **Clerk:** Aplicaci√≥n configurada

### **Pasos de Instalaci√≥n**

1. **Clonar repositorio**
2. **Instalar dependencias:** `npm install`
3. **Configurar variables de entorno**
4. **Ejecutar migraciones de base de datos**
5. **Configurar Clerk y Supabase**
6. **Iniciar desarrollo:** `npm run dev`

### **Comandos de Build**

```bash
# Desarrollo
npm run dev

# Build de producci√≥n
npm run build

# Iniciar producci√≥n
npm start

# Linting
npm run lint
```

---

## üìù NOTAS IMPORTANTES

### **Seguridad**

- ‚úÖ **Server Actions** para todas las operaciones de BD
- ‚úÖ **Autenticaci√≥n Clerk** obligatoria
- ‚úÖ **Control de permisos** por rol
- ‚úÖ **Validaci√≥n de datos** con Zod
- ‚úÖ **Claves sensibles** ocultas del frontend

### **Performance**

- ‚úÖ **Optimizaci√≥n de consultas** con √≠ndices
- ‚úÖ **Caching** de datos est√°ticos
- ‚úÖ **Lazy loading** de componentes
- ‚úÖ **Paginaci√≥n** en listas grandes

### **Mantenibilidad**

- ‚úÖ **TypeScript** para tipado fuerte
- ‚úÖ **Componentes reutilizables**
- ‚úÖ **Hooks personalizados**
- ‚úÖ **Documentaci√≥n completa**

---

## üéØ CONCLUSI√ìN

Este sistema POS est√° dise√±ado para ser **escalable, seguro y f√°cil de mantener**. La arquitectura basada en Server Actions garantiza que todas las operaciones cr√≠ticas se ejecuten en el servidor con autenticaci√≥n y autorizaci√≥n apropiadas.

**Caracter√≠sticas clave:**
- üîê **Seguridad total** con Clerk + Server Actions
- üí∞ **Gesti√≥n completa de caja** con lotes de operaciones
- üì¶ **Control de stock** por variantes (talle/color)
- üõí **Sistema de ventas** robusto con validaciones
- üìä **Reportes y an√°lisis** integrados
- üé® **Interfaz moderna** con shadcn/ui

**El sistema est√° listo para producci√≥n y puede ser replicado en m√∫ltiples ubicaciones manteniendo la consistencia de datos y seguridad.** 